# 交易系统面试场景题

> 用于复习交易所核心设计问题

---

## 1. 撮合交易一致性

**场景**: 撮合引擎完成一笔交易后，需要同时更新买方和卖方的资产。

**问题**:
- 如何保证买方和卖方的资产变更必须同时成功，不会出现"买方扣款成功、卖方加款失败"的情况？
- 如果买方和卖方不在同一个分片，如何处理跨分片的原子性？
- 内存结算成功但进程崩溃了怎么办？

---

## 2. 余额查询与热数据设计

**场景**: 用户下单时需要校验余额是否充足。

**问题**:
- 撮合交易时如何查询用户余额？为什么不能直接查数据库？
- 为什么要设计"热数据"（内存账户）和"冷数据"（数据库账本）两层架构？
- 热数据和冷数据如何保持一致？如果不一致怎么办？

---

## 3. 跨分片结算

**场景**: 买方在 Shard 1，卖方在 Shard 3，撮合成功后需要结算。

**问题**:
- 跨分片结算时如何保证原子性？
- 为什么不用分布式事务（如 XA、2PC）？
- 如果一个分片结算成功、另一个分片结算失败，如何恢复？

---

## 4. 数据库事务设计

**场景**: 成交事件写入数据库时，买方和卖方可能在不同的分库。

**问题**:
- 如果买方和卖方不在同一个数据库，如何保证事务？
- 流水表和余额表的分库策略应该如何设计？
- 余额表更新失败但流水已经写入，如何处理？

---

## 5. WAL 与恢复

**场景**: 交易系统使用 WAL（Write-Ahead Log）保证持久性。

**问题**:
- WAL 在交易系统中的作用是什么？
- 进程崩溃后如何从 WAL 恢复？
- WAL 和数据库的关系是什么？谁是"真相"？

---

## 6. 幂等性设计

**场景**: 网络抖动导致同一笔成交事件被重复投递。

**问题**:
- 如何保证重复投递不会导致重复结算？
- 幂等键应该如何设计？
- 在内存和数据库两层分别如何做幂等？

---

## 7. 资金冻结与解冻

**场景**: 用户下单需要冻结资金，撤单需要解冻资金。

**问题**:
- 为什么下单要先冻结资金再提交撮合？
- 部分成交后撤单，如何计算解冻金额？
- 冻结操作失败但撮合引擎已经收到订单，如何回滚？

---

## 8. 高并发下单

**场景**: 同一用户短时间内提交大量订单。

**问题**:
- 如何防止同一用户的订单互相竞争导致超卖？
- 分片设计如何利用到下单场景？
- 为什么分片内要单线程处理？

---

## 9. 强平引擎 - 风险等级计算

**场景**: 系统需要实时监控 20 万用户的仓位风险。

**问题**:
- 如何高效计算每个用户的风险率（保证金率）？
- 为什么要设计风险等级分层（Safe/Warning/Danger/Critical/Liquidate）？
- 风险等级索引如何设计才能支持无锁读取？
- 标记价格变动时，如何快速找到需要强平的用户？

---

## 10. 强平引擎 - 触发机制

**场景**: BTC 价格剧烈波动，可能有大量用户同时触发强平。

**问题**:
- 为什么不用定时轮询扫描所有用户？有什么问题？
- 如何实现"价格驱动"的强平触发（非轮询模式）？
- 如何避免"惊群效应"（大量用户同时触发强平）？
- 强平优先级如何设计？先平谁？

---

## 11. 强平引擎 - 执行流程

**场景**: 用户 A 被判定需要强平，需要执行强平操作。

**问题**:
- 强平单应该走正常撮合流程还是单独处理？为什么？
- 如何防止同一用户被多个节点重复强平？
- 强平过程中价格继续下跌怎么办？
- 部分强平和全部强平如何选择？

---

## 12. 保险基金与 ADL

**场景**: 用户强平后仓位穿仓（亏损超过保证金）。

**问题**:
- 穿仓损失由谁承担？保险基金如何运作？
- 保险基金不足时，ADL（自动减仓）如何触发？
- ADL 的对手方选择逻辑是什么？为什么选盈利用户？
- 如何设计 ADL 的公平性？

---

## 13. 预警引擎 - 实时监控

**场景**: 需要在用户风险率达到阈值时发送预警通知。

**问题**:
- 为什么预警引擎要和强平引擎分开？
- 预警阈值如何设计？多少级预警合适？
- 如何避免频繁预警打扰用户（防抖设计）？
- 预警通知的可靠性如何保证？

---

## 14. 预警引擎 - 价格触发

**场景**: 用户设置了价格预警，BTC 跌破 50000 时通知。

**问题**:
- 如何高效存储和查询百万级价格预警订阅？
- 为什么用 Redis ZSet 而不是数据库？
- 价格更新时如何快速找到触发的预警？
- 如何处理"惊群效应"（大量预警同时触发）？

---

## 15. 预警引擎 - 高性能设计

**场景**: 系统有 100 万用户订阅了价格预警，价格每秒更新 100 次。

**问题**:
- 如何设计才能支持高频价格更新 + 海量订阅？
- Redis ZSet 的 ZRANGEBYSCORE 在大数据量下的性能问题？
- 分页拉取（Pagination）如何解决惊群问题？
- Lua 脚本在预警系统中的作用？

---

## 16. 风控读取路径

**场景**: 强平引擎需要读取用户的持仓和余额进行风险计算。

**问题**:
- 强平引擎读取用户数据时，如何避免和交易引擎的锁竞争？
- 什么是"原子快照"？为什么用 `atomic.Pointer` 实现？
- 快照数据有延迟，会不会导致强平不及时？
- Copy-on-Write 模式在快照更新中的应用？

---

## 17. 强平引擎 - 风险计算公式

**场景**: 强平引擎需要根据用户持仓和余额计算是否触发强平。

**问题**:
- 永续合约的风险率（保证金率）如何计算？公式是什么？
- 未实现盈亏（uPnL）如何计算？多头和空头有什么区别？
- 维持保证金率和初始保证金率的区别？分别用在什么场景？
- 用户有多个仓位时，如何计算账户整体风险率？
- 标记价格和最新成交价的区别？为什么强平用标记价格？

---

---

## 18. 标记价格 - 指数与基差

**场景**: 交易所为了防止恶意爆仓，使用标记价格而不是最新成交价来计算强平。

**问题**:
- 标记价格（Mark Price）和最新成交价（Last Price）的区别？为什么强平要用标记价格？
- 指数价格（Index Price）如何计算？如何处理某个外部交易所价格异常（如插针、停机）？
- 什么是基差（Basis）？为什么要对基差做 EMA（指数移动平均）平滑？
- 权重配置（Binance 35%, OKX 25%...）如何影响指数价格？

---

## 19. 交割逻辑 - 到期结算

**场景**: 当季合约到期，系统需要对所有持仓进行自动交割结算。

**问题**:
- 为什么交割前（如最后1小时）通常会禁止开新仓？
- 结算价格（Settlement Price）为什么通常采用 TWAP（时间加权平均价）而不是最后一秒的价格？
- 如果有 100 万个持仓需要结算，如何设计避免数据库阻塞？（分批处理、Worker 模式）
- 结算时用户穿仓（余额变负）怎么处理？

---

## 20. 资金费率 - 锚定机制

**场景**: 永续合约没有到期日，价格可能会偏离现货价格。

**问题**:
- 资金费率（Funding Rate）的作用是什么？它是如何让合约价格锚定现货价格的？
- 资金费是平台收取的吗？（多空互付）
- 什么时候多头付给空头？（资金费率为正，合约价 > 现货价）
- 资金费率的计算公式通常包含哪两部分？（利率 + 溢价指数）

---

## 21. 持仓模型 - 盈亏计算

**场景**: 用户持有 BTCUSDT 多单，价格波动产生盈亏。

**问题**:
- 未实现盈亏（Unrealized PnL）和已实现盈亏（Realized PnL）的区别？
- 为什么未实现盈亏通常不存数据库，而是实时计算？
- 什么是"破产价格"（Bankruptcy Price）？它和强平价格有什么区别？
- 全仓模式（Cross）和逐仓模式（Isolated）在保证金计算上有什么不同？
